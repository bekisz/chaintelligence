#!/bin/bash

# 1. Get the absolute path of the directory where this script resides
SCRIPT_DIR=$(dirname "$(readlink -f "$0")")

# 2. Define the path to the .env file (one level up from /bin)
ENV_PATH="$(dirname "$SCRIPT_DIR")/.env"

# Function to generate a random 32-byte base64 string
generate_key() {
    python3 -c "import secrets, base64; print(base64.b64encode(secrets.token_bytes(32)).decode())"
}

echo "Generating unique Airflow keys..."

INTERNAL_API_SECRET_KEY=$(generate_key)
FERNET_KEY=$(generate_key)
AIRFLOW_SECRET_KEY=$(generate_key)
JWT_SECRET=$(generate_key)

# 3. Write to the .env file using the absolute path
cat << EOF >> "$ENV_PATH"
# -- This is generated by generate_secrets.sh --
## -- Begin ---
INTERNAL_API_SECRET_KEY=$INTERNAL_API_SECRET_KEY
FERNET_KEY=$FERNET_KEY
AIRFLOW_SECRET_KEY=$AIRFLOW_SECRET_KEY
JWT_SECRET=$JWT_SECRET

## -- End ---
EOF

echo "Success! Keys have been appended  to: $ENV_PATH, you can delete the previous content of the file if you want."
